<!DOCTYPE html>
<html>
<head>
    <title>Bescue - Mapmaker</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<script type="text/javascript" src="libs/jscolor.js"></script>

	

	<center>
		Name:&nbsp;<input id="map_name" maxlength="30" name="name" type="text" />
		Creator:&nbsp;<input id="map_creator" maxlength="30" name="creator" type="text" />
		Difficulty:&nbsp;<input  id="map_diff" maxlength="30" name="difficulty" value="1" min="0" max="25" type="number" />
	</center>

    <div>
       <center><canvas id="cSeb" width="1800" height="1220" tabindex="1" style="border:1px solid #000000;"></canvas></center>
    </div>
	<center>
	<br>
		<table border="0" cellpadding="1"  cellspacing="4" style="width: 90%;">
				<tbody>
					<tr>
						<td>
								<h1>Map</h1><br>
    							<div class="item">
    							  <a href="javascript:bSave();" class="btn-grn">Save</a>
    							<br><div id="download">&nbsp;</div>
    							<br><br><br>
    								<input type="file" id="files" type = "json" />
    							</div>
						</td>
						<td>
							<h1>Object</h1><br>
							<div class="item">
    							  <a href="javascript:bNew();" class="btn-blu">New</a>
    							   <br><br><br><br>
    							  <a href="javascript:bDelete();" class="btn-red">Delete</a>
    						</div>
						</td>
						<td>
							<table border="0" cellpadding="1" cellspacing="0" style="width: 100%;">
						</td>
			<tbody>
				<tr>
					<td>
						Type: <select id="obj_type" name="type_objekt" size="1" onchange="updateObject(-1)"><option selected="selected" value="player">Player</option><option value="spikes">Spikes</option><option value="ground">Ground</option><option value="spring">Spring</option><option value="goal">Goal</option><option value="coin">Coin</option><option value="shield">Shield</option></select>
					</td>
					<td>
						<b>ObjectID:</b> <select id="obj_id" name="type_objekt" size="1" onchange="updateObject(-2)" value="empty"></select>
					</td>
				</tr>
				<tr>
					<td>
						<b>X:</b> <input id="obj_x" maxlength="20" name="pos_x" value="0" type="number" onchange="updateObject(-1)" />
					</td>
					<td>
						<b>Y:</b> <input id="obj_y" maxlength="20" name="pos_y" value="0" type="number" onchange="updateObject(-1)" />
					</td>
				</tr>
				<tr>
					<td>
						<b>Width:</b> <input id="obj_w"maxlength="20" name="width" min="0" value="100" type="number" onchange="updateObject(-1)" />
					</td>
					<td>
						<b>Height:</b> <input id="obj_h" maxlength="20" name="height" min="0" value="100" type="number" onchange="updateObject(-1)" />				
					</td>
				</tr>
				<tr>
					<td>
						<b>Angle:</b> <input id="obj_angle" maxlength="20" name="angle" min="0" max="360" value="0" type="number" onchange="updateObject(-1)" />
					</td>
					<td>
						<b>Power:</b> <input id="obj_power" maxlength="5" name="power" min="0" value="0" type="number" onchange="updateObject(-1)" />
					</td>
				</tr>
				<tr>
					<td><b>Colour:</b> <input id="obj_color" class="color" value="FFFFFF" onchange="updateObject(-1)"></td>
					<td>Null</td>
				</tr>
			</tbody>
		</table>
						</td>
					</tr>
				</tbody>
			</table>
	</center>
<script>
//   ______   _______           _______ _________ _______  _______ 
//  (  ___ \ (  ____ \|\     /|(  ____ \\__   __/(  ____ \(  ____ )
//  | (   ) )| (    \/| )   ( || (    \/   ) (   | (    \/| (    )|
//  | (__/ / | (__    | |   | || (_____    | |   | (__    | (____)|
//  |  __ (  |  __)   ( (   ) )(_____  )   | |   |  __)   |     __)
//  | (  \ \ | (       \ \_/ /       ) |   | |   | (      | (\ (   
//  | )___) )| (____/\  \   /  /\____) |   | |   | (____/\| ) \ \__
//  |/ \___/ (_______/   \_/   \_______)   )_(   (_______/|/   \__/.net
//  Sebulus (C) 2014

// Globale elementas
var canv;
var gfx;
var refreshRate = 1000 / 30;
var Cam;
var js = null;


// Values
var app_name = "Bescue_mapmaker";
var color = "#1d1d1d";
var WORLD_BOX = 0.01;
var BOX_WORLD = 100;
var ID_SELECTED = 0;
var MODUS = 0;
var CANVAS_FOCUSED = false;

var OBJ_DRAG = false;


// Tabeller
var Objekter = new Array();

function MapMaker()
{
    canv = document.getElementById('cSeb');
    canv.onselectstart = function () { return false; } // ie
	canv.onmousedown = function () { return false; } // mozilla
    gfx = canv.getContext("2d");
    console.info('['+ app_name +'] Started');
    init();
}

function init()
{
    console.info('['+ app_name +'] Initialised');
    console.info('['+ app_name +'] Domain: ' + window.location.hostname);
    console.info('['+ app_name +'] Dim: ( ' + canv.width + ', ' + canv.height +  ' )' );
    canv.height = window.innerHeight;
    canv.width = window.innerWidth;
    //canv.addEventListener('keydown', keyPressed, true);
    console.info('['+ app_name +'] Dim: ( ' + canv.width + ', ' + canv.height +  ' )' );

    Cam = new Camera(-10, (canv.height * 0.9) - 10, canv.width, canv.height);
    js = new JSONHandler();

    setInterval(update, refreshRate);
}

function update()
{
    logic();
    render();
}

function logic(){}

function render()
{
    clearCanvas();
    gfx.fillStyle = color;
    gfx.fillRect(0, 0, canv.width, canv.height);
    document.bgColor = "#FFFFFF";

    Cam.draw();

    gfx.fillStyle = "white";
    gfx.fillRect(Cam.x, Cam.y, (10 * WORLD_BOX) / Cam.zoom, (10 * WORLD_BOX) / Cam.zoom);


    var string = "tom";
    switch(MODUS)
	{
	case 0:
		string = "MOVE";
	break;
	case 1:
		string = "ROTATION";
	  break;
	default:
		string = "EMPTY";
	break;
	}

    gfx.fillStyle = 'white';
    gfx.fillText( " Cam_pos: " + Cam.x + ", " + Cam.y + " Modus: " +  string, 0, 10 );

}

// Knapper
function bNew()
{
	if(Objekter != null)
	{
		var objID = document.getElementById("obj_id");
		var objType = document.getElementById("obj_type");
		var objX = document.getElementById("obj_x");
		var objY = document.getElementById("obj_y");
		var objW = document.getElementById("obj_w");
		var objH = document.getElementById("obj_h");
		var objAngle = document.getElementById("obj_angle");
		var objPower = document.getElementById("obj_power");
		var objCol = document.getElementById("obj_color");
		var id = 0;
		
		if(Objekter.length == 0){id = 0;}else{id = Objekter.length;}
		Objekter.push(new Object( id, objType.value, objX.value, objY.value, objW.value, objH.value, objAngle.value, objPower.value, objCol.value));
		console.log("Created: " + Objekter.length + " - " +  objType.value);
		updateIdList();
		objID.value = id;
		ID_SELECTED = id;
	}else{
		Objekter = new Array();
	}
}

function bDelete()
{
	var del = false;
	if(Objekter != null)
	{
		var objID = document.getElementById("obj_id");

		Objekter[objID.value] = null;
		updateIdList();

		for (var i = 0; i < Objekter.length; i++) {
			if(Objekter[i] == null)
			{
				del = true;
			}else{
				del = false;
				return;
			}
		};
		if(del == true)
			Objekter = null;
	}
}

function updateIdList()
{
	if(Objekter != null && Objekter.length > 0)
	{
		var idSelection = document.getElementById("obj_id");
		idSelection.innerHTML = "";
		for(var i = 0; i < Objekter.length; i++)
	 	{
	 		if(Objekter[i] != null)
			{
				var el = document.createElement("option");
    			el.textContent = Objekter[i].id + "." + Objekter[i].type;
    			el.value = Objekter[i].id;
    			idSelection.appendChild(el);
			}
		}
	}
}

function updateObject(val)
{
	if(Objekter != null && Objekter.length > 0)
	{
		var id = document.getElementById("obj_id").value;
		if(id != null && id >= 0)
		{
			if(val == -1)
			{
				var objID = document.getElementById("obj_id");
				var objType = document.getElementById("obj_type");
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				var objW = document.getElementById("obj_w");
				var objH = document.getElementById("obj_h");
				var objAngle = document.getElementById("obj_angle");
				var objPower = document.getElementById("obj_power");
				var objCol = document.getElementById("obj_color");


				Objekter[id].update(objType.value, objX.value, objY.value, objW.value, objH.value, objAngle.value, objPower.value, objCol.value);
				ID_SELECTED = objID.value;
			}else if(val == -2)
			{
				var id  = document.getElementById("obj_id").value;
				document.getElementById("obj_type").value = Objekter[id].type;
				document.getElementById("obj_x").value = Objekter[id].x;
				document.getElementById("obj_y").value = -Objekter[id].y;
				document.getElementById("obj_w").value = Objekter[id].width * BOX_WORLD;
				document.getElementById("obj_h").value = Objekter[id].height * BOX_WORLD;
				document.getElementById("obj_angle").value = 360 - Objekter[id].angle;
				document.getElementById("obj_power").value = Objekter[id].power;
				document.getElementById("obj_color").value = Objekter[id].color;


				ID_SELECTED = id;

			}else{
				var id  = val;
				document.getElementById("obj_id").value = id;
				document.getElementById("obj_type").value = Objekter[id].type;
				document.getElementById("obj_x").value = Objekter[id].x;
				document.getElementById("obj_y").value = -Objekter[id].y;
				document.getElementById("obj_w").value = Objekter[id].width * BOX_WORLD;
				document.getElementById("obj_h").value = Objekter[id].height * BOX_WORLD;
				document.getElementById("obj_angle").value = 360 - Objekter[id].angle;
				document.getElementById("obj_power").value = Objekter[id].power;
				document.getElementById("obj_color").value = Objekter[id].color;


				ID_SELECTED = id;
			}
		}
	}
}

function bSave()
{
	js.toJSON();
}

function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {

      // Only process image files.
      if (f.type.match('application/json')) {
        continue;
      }

      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
         js.loadJSON(JSON.parse(this.result));
        };
      })(f);

      // Read in the image file as a data URL.
      reader.readAsText(f);
    }
  }
document.getElementById('files').addEventListener('change', handleFileSelect, false);

// Objects
function Camera(x, y, w, h)
{
	this.x = x;
	this.y = -y;
	this.zoom = 0.1;
	this.width = w * this.zoom;
	this.height = h * this.zoom;

}

Camera.prototype.setPos = function(x, y)
{
	this.x = x;
	this.y = -y;
}

Camera.prototype.draw = function()
{
	
	this.width *= this.zoom;
	this.height *= this.zoom;

	if(Objekter != null && Objekter.length > 0)
	{
		for (var i = 0; i < Objekter.length; i++)
		{
			if(Objekter[i] != null)
			{
				Objekter[i].draw(this);
			}
		}
	}
}

function Object( id, type, x, y, w, h, angle, power, color)
{

	this.id = id;
	this.type = type;
	this.x = x;
	this.y = -y;
	this.width = w * WORLD_BOX;
	this.height = h * WORLD_BOX;
	this.angle = (360 - angle);
	this.power = power;
	this.color = color;
}

Object.prototype.update = function(type, x, y, w, h, angle, power, color)
{
	this.type = type;
	this.x = x;
	this.y = -y;
	this.width = w * WORLD_BOX;
	this.height = h * WORLD_BOX;
	this.angle = (360 - angle);
	this.power = power;
	this.color = color;

}

Object.prototype.draw = function(c)
{
	if(c != null)
	{
		var dX = this.x - c.x;
		var dY = this.y - c.y;

		var dWidth = this.width / c.zoom; 
		var dHeight = -(this.height / c.zoom); 

		// Thank you "user1602942" at Stack_Overflow <3
		//Convert degrees to radian 
		var rad = this.angle * Math.PI / 180;
    	//Set the origin to the center of the image
    	gfx.translate(dX, dY);
    	gfx.rotate(rad);
    	
    	if(ID_SELECTED == this.id){
    		gfx.fillStyle = 'white';
    	}else{
    		gfx.fillStyle = 'black';
    	}

    	gfx.fillRect((dWidth  + 1)/ 2 * (-1), (dHeight + 1) / 2 * (-1), dWidth + 1, dHeight + 1);
    	if(this.type == 'player')
		{
			gfx.fillStyle = 'orange';
		}else if(this.type == 'spikes')
		{
			gfx.fillStyle = 'red';
		}else if(this.type == 'spring')
		{
			gfx.fillStyle = 'blue';
		}else if(this.type == 'goal')
		{
			gfx.fillStyle = 'green';
		}else if(this.type == 'coin')
		{
			gfx.fillStyle = 'yellow';
		}else if(this.type == 'ground')
		{
			gfx.fillStyle = this.color;
		}else
		{
			gfx.fillStyle = 'white';
		}
    	gfx.fillRect(dWidth / 2 * (-1), dHeight / 2 * (-1), dWidth, dHeight);
    	//malingen på toppen
    	gfx.fillStyle = 'black';
    	gfx.fillRect((dWidth / 2 * (-1)), (dHeight / 2 * (-1)), dWidth, (dHeight * 0.90));
    	//Reset the canvas  
    	gfx.rotate(rad * ( -1 ) );
    	gfx.translate(dX * (-1), dY * (-1));
    	//ObjectCords
    	gfx.fillStyle = 'pink';
    	gfx.fillRect(dX, dY, 2, 2);


	}
}

// Read and write to JSON :)
function JSONHandler(){}

JSONHandler.prototype.toJSON = function()
{
	if(Objekter != null && Objekter.length > 0)
	{
		var map_name = document.getElementById("map_name");
		var map_creator = document.getElementById("map_creator");
		var map_difficulty = document.getElementById("map_diff");
		if(map_name.value != '' && map_creator.value != '' && map_difficulty != '')
		{	
			var mObjects = {};
			mObjects['map_name'] = map_name.value;
			mObjects['map_creator'] = map_creator.value;
			mObjects['map_difficulty'] = map_difficulty.value;
			mObjects['map_created'] = (new Date().getUTCDate() + "." + (new Date().getUTCMonth() + 1) + "." + new Date().getUTCFullYear());
			mObjects['map_objects'] = []; 
			for (var i = 0; i < Objekter.length; i++)
			{
				if(Objekter[i] != null)
				{
					var objs = {};
					objs = Objekter[i];
					mObjects['map_objects'].push(objs);
				}
			
			};
			var jsons = JSON.stringify(mObjects);
			console.log(jsons);		

			var blob = new Blob([jsons], {type: "application/json"});
			var url  = URL.createObjectURL(blob);
			console.log(url);
			
			var a = document.createElement('a');
			a.download    = map_name.value + ".json";
			a.href        = url;
			a.textContent = "Download";
			document.getElementById('download').replaceChild(a, document.getElementById('download').childNodes[0]);

    		}else
    		{
    			alert("["+app_name+"]: Map information can not be null");
    		}
		
    }
    
}

JSONHandler.prototype.loadJSON = function(json)
{
	if(json != null)
	{
		Objekter = new Array();
		var map_name = document.getElementById("map_name");
		var map_creator = document.getElementById("map_creator");
		var map_difficulty = document.getElementById("map_diff");
		var objID = document.getElementById("obj_id");


		map_name.value = json.map_name;
		map_creator.value = json.map_creator;
		map_difficulty.value = json.map_difficulty;

		for (var i = 0; i < json.map_objects.length; i++) {
			var ob = json.map_objects[i];
			Objekter.push(new Object( i, ob.type, ob.x, -ob.y, ob.width * BOX_WORLD, ob.height * BOX_WORLD,  (360 - ob.angle), ob.power, ob.color));
			objID.value = i;
			ID_SELECTED = i;
		};
		updateIdList();
	}
}



addEventListener('keydown', function(e){
	if(CANVAS_FOCUSED)
	{
		var camMove = 15;
		var objMove = 1	
		// Movement
		//====================
		//	THE W KEY
		//====================
		if (e.keyCode == 87)
		{
			Cam.setPos(Cam.x, -Cam.y + camMove);
		}
		//====================
		//	THE S KEY
		//====================
		if (e.keyCode == 83)
		{
			Cam.setPos(Cam.x, -Cam.y - camMove);
		}
		//====================
		//	THE A KEY
		//====================
		if (e.keyCode == 65)
		{
			Cam.setPos(Cam.x - camMove, -Cam.y)	
		}
		//====================
		//	THE D KEY
		//====================
		if (e.keyCode == 68)
		{
			Cam.setPos(Cam.x + camMove, -Cam.y);
		}
		//----------------------------------\	
		//Object changes
		
		//====================
		//	THE R KEY
		// Set the modus
		//====================
		if (e.keyCode == 82)
		{
			switch(MODUS)
			{
				case 0:
					MODUS = 1;
				break;
				case 1:
					MODUS = 0;
				  break;
				default:
					MODUS = 0;
				break;
			}
		}
			
		//====================
		//	THE I KEY
		//====================
		if (e.keyCode == 73)
		{
			if(Objekter != null && Objekter.length > 0)
			{
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				var objW = document.getElementById("obj_w");
				var objH = document.getElementById("obj_h");
				var objAngle = document.getElementById("obj_angle")	
				switch(MODUS)
				{
					case 0:
					objY.value = Math.round((parseInt(objY.value) + objMove));
					break;
					case 1:
					objH.value = Math.round((parseInt(objH.value) + objMove));
					break;
					case 2:
					break;
					default:
					break;
				}
				updateObject(-1);
			}
		}
		//====================
		//	THE K KEY
		//====================
		if (e.keyCode == 75)
		{
			if(Objekter != null && Objekter.length > 0)
			{
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				var objW = document.getElementById("obj_w");
				var objH = document.getElementById("obj_h");
				var objAngle = document.getElementById("obj_angle")	
				switch(MODUS)
				{
					case 0:
					objY.value = Math.round(parseInt(objY.value) - objMove);
					break;
					case 1:
					objH.value = Math.round(parseInt(objH.value) - objMove);
					break;
					case 2:
					break;
					default:
					break;
				}
				updateObject(-1);
			}
		}
		//====================
		//	THE L KEY
		//====================
		if (e.keyCode == 76)
		{
			if(Objekter != null && Objekter.length > 0)
			{
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				var objW = document.getElementById("obj_w");
				var objH = document.getElementById("obj_h");
				var objAngle = document.getElementById("obj_angle")	
				switch(MODUS)
				{
					case 0:
					objX.value = Math.round(parseInt(objX.value) + objMove);
					break;
					case 1:
					objW.value = Math.round(parseInt(objW.value) + objMove);
					break;
					case 2:
					if(parseInt(objAngle.value) > 0){objAngle.value = Math.round(parseInt(objAngle.value) - objMove);}
					break;
					default:
					break;
				}
				updateObject(-1);
			}
		}
		//====================
		//	THE J KEY
		//====================
		if (e.keyCode == 74) {
			if(Objekter != null && Objekter.length > 0)
			{
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				var objW = document.getElementById("obj_w");
				var objH = document.getElementById("obj_h");
				var objAngle = document.getElementById("obj_angle")	
				switch(MODUS)
				{
					case 0:
					objX.value = Math.round(parseInt(objX.value) - objMove);
					break;
					case 1:
					objW.value = Math.round(parseInt(objW.value) - objMove);
					break;
					case 2:
					if(parseInt(objAngle.value) < 360){objAngle.value = Math.round(parseInt(objAngle.value) + objMove);}
					break;
					default:
					break;
				}
				updateObject(-1);					
			}
		}
			
		//----------------------------------\	
		//Zooom
		//====================
		//	THE DELETE KEY
		//====================
		if (e.keyCode == 177)
		{
			bDelete();
		}
		//====================
		//	THE ESCAPE KEY
		//====================
	
	}

	if (e.keyCode == 27) 
	{
			bNew();
	}
}, true);

//Mouselistener
addEventListener('mousedown', function(e)
{
	CANVAS_FOCUSED = false;
	if(Objekter != null && Objekter.length > 0)
	{
		var bRect = canv.getBoundingClientRect();
		mouseX = parseInt((e.clientX - bRect.left)*(canv.width/bRect.width)) + (Cam.x);
		mouseY = (-((e.clientY - bRect.top)*(canv.height/bRect.height))) - (Cam.y);

		meX = parseInt((e.clientX - bRect.left)*(canv.width/bRect.width));
		meY = (((e.clientY - bRect.top)*(canv.height/bRect.height)));

		if(meY < canv.height && meY > 0)
		{
			if(meX < canv.width && meX > 0)
			{
				e.preventDefault();
				document.getElementById('cSeb').focus();
				CANVAS_FOCUSED = true;
				for (var i = 0; i < Objekter.length; i++) 
				{
					if(Objekter[i] != null)
					{
						var a = parseInt(Objekter[i].x) - (parseInt(Objekter[i].width) / Cam.zoom);
						var b = -(parseInt(Objekter[i].y) + (parseInt(Objekter[i].height) / Cam.zoom));
						var c = parseInt(Objekter[i].x) + (parseInt(Objekter[i].width) / Cam.zoom);
						var d = -(parseInt(Objekter[i].y) - (parseInt(Objekter[i].height) / Cam.zoom));
						if(mouseX >= a && mouseX <= c)
						{
							if(mouseY >= b && mouseY <= d)
							{
								ID_SELECTED = Objekter[i].id;
								updateObject(Objekter[i].id);
								OBJ_DRAG = true;
							}
						}
					}
				};
			}
		}
	}
}, true);

addEventListener('mousemove', function(e)
{
	if(CANVAS_FOCUSED)
	{
		if(Objekter != null && Objekter.length > 0)
		{
			if(OBJ_DRAG)
			{
				var bRect = canv.getBoundingClientRect();
				mouseX = parseInt((e.clientX - bRect.left)*(canv.width/bRect.width)) + (Cam.x);
				mouseY = parseInt(-((e.clientY - bRect.top)*(canv.height/bRect.height))) - (Cam.y);
				var objX = document.getElementById("obj_x");
				var objY = document.getElementById("obj_y");
				switch(MODUS)
				{
					case 0:
						objX.value = Math.round(mouseX);
						objY.value = Math.round(mouseY);
						updateObject(-1);					
					break;
					case 1:
						var objAngle = document.getElementById("obj_angle");
						if(parseInt(objX.value) < mouseX)
						{
							if(parseInt(objAngle.value) < 360){objAngle.value = Math.round(parseInt(objAngle.value) + 1);}
						}else{
							if(parseInt(objAngle.value) > 0){objAngle.value = Math.round(parseInt(objAngle.value) - 1);}
						}
						updateObject(-1);					
					break;
					default:
					break;
				}
			}
		}
	}	
}, true);

addEventListener('mouseup', function(e){if(OBJ_DRAG == true) OBJ_DRAG = false;}, true);

function clearCanvas()
{
    canv.height = window.innerHeight * 0.90;
    canv.width = window.innerWidth * 0.90;
    Cam.width = canv.width * Cam.zoom;
	Cam.height = canv.height * Cam.zoom;
}

MapMaker();
</script>
</body>
</html>